Record Stats PPX
================

The Record Stats PPX is designed to make it easy to statistically analyze datasets. Given a record type, `t`, you can annotate `t`s fields, and then call a single function to generate a report that describes the proportion of field values that are null, the number of field string values that are invalid, etc.

Example
-------

For example, given the record type, `t`, the following annotations tell the library that that `t`s `a` field is a string that should equal "true" or "false"; and that its `b` field is an int that should be greater than 0.

```ocaml
type t = {
  a: string option;
      [@stats
        [|
          Str_enum {
            spec = { valid_values = String.Set.of_list [ "true"; "false" ] };
            transform = Fn.id;
          }
        |]
      ]
  b: int;
      [@stats
        [|
          Int_ranged { spec = { low = Some 0; high = None }; transform = Option.some }
        |]
      ]
}
[@@deriving fields, record_stats]
```

Given a list of `t` values, `xs`, we can generate a statistics report for `xs` by simply calling `Stats.report xs`. For example:

```ocaml
let xs = [ { a = Some "true"; b = 1 }; { a = Some "false"; b = 0 } ]

let () =
  Stats.report xs
  |> [%to_yojson: Stats.report]
  |> sprintf !"%{Yojson.Safe.pretty_to_string}"
  |> print_endline
```

The resulting report will list information about the values of the fields in `xs`:

```lisp
(((field_name a_stats)
  (reports
   ((Str_enum
     ((num_values 2) (distrib ((false 1) (true 1))) (num_invalid_values 0)
      (prop_invalid_values 0))))))
 ((field_name b_stats)
  (reports
   ((Int_ranged
     ((num_values 2) (num_invalid_values 0) (prop_invalid_values 0) (min (0))
      (max (1))))))))
```

Usage in Other Projects
-----------------------

To use this PPX library in another project include the `ppx_record_stats` library in your Dune file's preprocess section. For example:

```
(executable
 (name main)
 (libraries
  core_kernel
  )
 (preprocess
  (pps ppx_jane ppx_record_stats))
  (modes exe)
)
```

You must also update your OPAM package configuration file. Add the following line to your "pin-depends" section: `["ppx_record_stats.0.1.0" "git+https://github.com/llee454/ppx_record_stats.git#main"]`. Add the following to your "depends" section: `  "ppx_record_stats" { = "0.1.0"}`.

Usage
-----

This library defines a variety of field types. These are listed below:

| Sort        | Field type | Spec type |
| ----------- | ---------- | --------- |
| Date_ranged | Date.t     | { start_date: Date.t option; end_date: Date.t option; granularity = Weeks|Months|Years } |
| Formatted   | string     | { format: Re.re } |
| Int_ranged  | int        | { low: int option; high: int option } |
| Linked      | 'a         | { get_num_matches : 'a -> int } |
| Nullable    | 'a option  | unit |
| Str_enum    | string     | { valid_values: String.Set.t } |

Each field annotation includes a record with three fields: `SORT { spec; transform }` where `SORT` is one of the constructors listed above and `spec` depends on the sort.

For example:

```ocaml
[@stats
  [|
    Str_enum {
      spec = { valid_values = String.Set.of_list [ "true"; "false" ] };
      transform = Fn.id;
    }
  |]
]
```

is a valid field annotation.

You must attach the PPX annotation to each type definition you are trying to analyze.

This library will create a module named `Stats` in the same context as the type definition. To prevent this module from conflicting with other definitions, you may need to enclose the type definition in its own module.

To generate a report, call `Stats.report xs` where `xs` denotes the dataset and has type `xs : t list`.


Initializing the Build Environment
----------------------------------

Note: the following are a hack solution to fix the fact that brew and opam are
out of sync and opam's owl-plplot library requires library versions that can no
longer be installed with brew.

```
opam switch create . ocaml-variants.4.10.0+flambda --no-install
opam update
opam install --deps-only .
dune build

Known Bugs
----------

1. The types defined by the module generated by this PPX are not compatible with the -unboxed-types Dune build flag when the target record only has a single annotated field.